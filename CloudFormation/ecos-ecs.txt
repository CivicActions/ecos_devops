{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "Template to create core ECOS resources.",
  "Parameters": {
    "ApiECSClusterName": {
      "Type": "String",
      "Description": "Specifies the ECS Cluster Name with which the resources would be associated",
      "Default": "ecos-api-ecs-cluster"
    },
    "WebECSClusterName": {
      "Type": "String",
      "Description": "Specifies the ECS Cluster Name with which the resources would be associated",
      "Default": "ecos-web-ecs-cluster"
    },
    "SecurityGroupIDs": {
      "Type": "CommaDelimitedList",
      "Default": "sg-0de3c1e1a134c66d8"
    },
    "SubnetIDs": {
      "Type": "CommaDelimitedList",
      "Default": "subnet-0941b88ce2f2f04c0,subnet-006cfb1b38a9040d2,subnet-0dea032c80563fb24,subnet-054df7c9fbcdbae9e,subnet-0160efb3bae4e4d37,subnet-08b52b072d0f1b4c3"
    },
    "WebVpcID": {
      "Type": "String",
      "Default": "vpc-0c6e6c6c8632fb271"
    },
  },
  "Resources": {
    "ApiECSCluster": {
      "Type": "AWS::ECS::Cluster",
      "Properties": {
        "ClusterName": {
          "Ref": "ApiECSClusterName"
        },  
        "CapacityProviders": [
          "FARGATE",
          "FARGATE_SPOT"
        ],
        "ClusterSettings": [
          {
            "Name": "containerInsights",
            "Value": "disabled"
          }
        ],
        "Configuration": {
          "ExecuteCommandConfiguration": {
            "Logging": "DEFAULT"
          }
        },
        "ServiceConnectDefaults": {
          "Namespace": "ecos-api-ecs-cluster"
        },
        "Tags": [
          {
            "Key": "Name",
            "Value": "ecos-api-ecs-cluster"
          }
        ]
      }
    },
    "WebECSCluster": {
      "Type": "AWS::ECS::Cluster",
      "Properties": {
        "ClusterName": {
          "Ref": "WebECSClusterName"
        },
        "CapacityProviders": [
          "FARGATE",
          "FARGATE_SPOT"
        ],
        "ClusterSettings": [
          {
            "Name": "containerInsights",
            "Value": "disabled"
          }
        ],
        "Configuration": {                                                          "ExecuteCommandConfiguration": {
            "Logging": "DEFAULT"
          }
        },
        "ServiceConnectDefaults": {
          "Namespace": "ecos-web-ecs-cluster"
        },
        "Tags": [
          {
            "Key": "Name",
            "Value": "ecos-web-ecs-cluster"
          }
        ]
      }
    },
    "ApiTaskDefinition": {
      "Type" : "AWS::ECS::TaskDefinition",
      "Properties" : {
        "containerDefinitions": [
        {
          "name": "ecos-api-cont",
          "image": "058264367679.dkr.ecr.us-east-1.amazonaws.com/ecos-api-repo:latest",
          "cpu": 0,
          "portMappings": [
            {
              "name": "ecos-api-cont-8001-tcp",
              "containerPort": 8001,
              "hostPort": 8001,
              "protocol": "tcp"
            }
          ],
          "essential": true,
          "environment": [
            {
              "name": "VERSION",
              "value": "v1"
            },
            {
              "name": "ENVIRONMENT",
              "value": "dev"
            }
          ],
          "mountPoints": [],
          "volumesFrom": [],
          "workingDirectory": "/app",
          "logConfiguration": {
            "logDriver": "awslogs",
            "options": {
              "awslogs-group": "/ecs/ecos-api",
              "awslogs-region": "us-east-1",
              "awslogs-stream-prefix": "ecos-api"
            }
          }
        }
        ],
        "Cpu" : 4096,
        "ExecutionRoleArn" : "arn:aws:iam::058264367679:role/ecos-ecs-task-execution-role",
        "Family" : "ecos-api-td",
        "Memory" : 8192,
        "NetworkMode" : "awsvpc",
        "RequiresCompatibilities" : [ "FARGATE" ],
        "TaskRoleArn" : "arn:aws:iam::058264367679:role/ecos-ecs-task-role"
      }
    },
    "WebTaskDefinition": {
      "Type" : "AWS::ECS::TaskDefinition",
      "Properties" : {
        "ContainerDefinitions" : [
        {
          "name": "ecos-ui-cont",
          "image": "058264367679.dkr.ecr.us-east-1.amazonaws.com/ecos-web-repo:latest",
          "cpu": 0,
          "portMappings": [
          {
            "name": "ecos-ui-cont-8002-tcp",
            "containerPort": 8002,
            "hostPort": 8002,
            "protocol": "tcp"
          }
          ],
          "essential": true,
          "environment": [
          {
            "name": "VERSION",
            "value": "v1"
          },
          {
            "name": "ENVIRONMENT",
            "value": "dev"
          }
          ],
          "mountPoints": [],
          "volumesFrom": [],
          "workingDirectory": "/app",
          "logConfiguration": {
          "logDriver": "awslogs",
          "options": {
            "awslogs-group": "/ecs/ecos-ui",
            "awslogs-region": "us-east-1",
            "awslogs-stream-prefix": "ecos-ui"
          }
          }
        }
        ],
        "Cpu" : 4096,
        "ExecutionRoleArn" : "arn:aws:iam::058264367679:role/ecos-ecs-task-execution-role",
        "Family" : "ecos-ui-td",
        "Memory" : 8192,
        "NetworkMode" : "awsvpc",
        "RequiresCompatibilities" : [ "FARGATE" ],
        "TaskRoleArn" : "arn:aws:iam::058264367679:role/ecos-ecs-task-role"
      }
    },
    -------------------- FIXME
    "ApiSecurityGroup": {
      "Type" : "AWS::EC2::SecurityGroup",
      "Properties" : {
        "GroupDescription" : "ecos-api-alb-sg",
        "GroupName" : "ecos-api-alb-sg",
        "SecurityGroupEgress" : [
          {
            "CidrIp" : "0.0.0.0/0",
            "IpProtocol" : "-1",
          },
        ],
        "SecurityGroupIngress" : [
          {
            "CidrIp" : "0.0.0.0/0",
            "IpProtocol" : "-1",
          },
        ],
        "Tags": [
          {
            "Key": "Name",
            "Value": "ecos-api-alb-sg"
          },
          {
            "Key": "Environment",
            "Value": "dev"
          }
        ],
        "VpcId" : "vpc-0c6e6c6c8632fb271"
      }
    },
    "WebSecurityGroup": {
      "Type" : "AWS::EC2::SecurityGroup",
      "Properties" : {
        "GroupDescription" : "ecos-web-alb-sg",
        "GroupName" : "ecos-web-alb-sg",
        "SecurityGroupEgress" : [
          {
            "CidrIp" : "0.0.0.0/0",
            "IpProtocol" : "-1",
          },
        ],
        "SecurityGroupIngress" : [
          {
            "CidrIp" : "0.0.0.0/0",
            "FromPort" : 0,
            "IpProtocol" : "tcp",
            "ToPort" : 0,
          },
        ],
        "Tags": [
          {
            "Key": "Name",
            "Value": "ecos-web-alb-sg"
          },
          {
            "Key": "Environment",
            "Value": "dev"
          }
        ],
        "VpcId" : "vpc-0c6e6c6c8632fb271"
      }
    },
    ---------------------FIXME: DEFAULT SECURITY GROUP: third in aws ec2 describe-security-groups
    "ApiECSService": {
      "Type": "AWS::ECS::Service",
      "Properties": {
        "Cluster": "ecos-api-ecs-cluster",
        "CapacityProviderStrategy": [
          {
            "CapacityProvider": "FARGATE",
            "Base": 0,
            "Weight": 1
          }
        ],
        "TaskDefinition": "arn:aws:ecs:us-east-1:058264367679:task-definition/ecos-api-td:1",
        "ServiceName": "ecos-api-service",
        "SchedulingStrategy": "REPLICA",
        "DesiredCount": 1,
        "NetworkConfiguration": {
          "AwsvpcConfiguration": {
            "AssignPublicIp": "ENABLED",
            "SecurityGroups": {
              "Ref": "SecurityGroupIDs"
            },
            "Subnets": {
              "Ref": "SubnetIDs"
            }
          }
        },
        "PlatformVersion": "LATEST",
        "DeploymentConfiguration": {
          "MaximumPercent": 200,
          "MinimumHealthyPercent": 100,
          "DeploymentCircuitBreaker": {
            "Enable": true,
            "Rollback": true
          }
        },
        "DeploymentController": {
          "Type": "ECS"
        },
        "ServiceConnectConfiguration": {
          "Enabled": false
        },
        "Tags": [
          {
            "Key": "Name",
            "Value": "ecos-api-service"
          },
          {
            "Key": "Environment",
            "Value": "dev"
          }
        ],
        "EnableECSManagedTags": true
      }
    },
    "WebECSService": {
      "Type": "AWS::ECS::Service",
      "Properties": {
        "Cluster": "ecos-web-ecs-cluster",
        "CapacityProviderStrategy": [
          {
            "CapacityProvider": "FARGATE",
            "Base": 0,
            "Weight": 1
          }
        ],
        "TaskDefinition": "arn:aws:ecs:us-east-1:058264367679:task-definition/ecos-ui-td:1",
        "ServiceName": "ecos-ui-service",
        "SchedulingStrategy": "REPLICA",
        "DesiredCount": 1,
        "NetworkConfiguration": {
          "AwsvpcConfiguration": {
            "AssignPublicIp": "ENABLED",
            "SecurityGroups": {
              "Ref": "SecurityGroupIDs"
            },
            "Subnets": {
              "Ref": "SubnetIDs"
            }
          }
        },
        "PlatformVersion": "LATEST",
        "DeploymentConfiguration": {
          "MaximumPercent": 200,
          "MinimumHealthyPercent": 100,
          "DeploymentCircuitBreaker": {
            "Enable": true,
            "Rollback": true
          }
        },
        "DeploymentController": {
          "Type": "ECS"
        },
        "ServiceConnectConfiguration": {
          "Enabled": false
        },
        "Tags": [
          {
            "Key": "Name",
            "Value": "ecos-ui-service"
          },
          {
            "Key": "Environment",
            "Value": "dev"
          }
        ],
        "EnableECSManagedTags": true
      }
    },
    "ECSApiTargetGroup": {
      "Type" : "AWS::ElasticLoadBalancingV2::TargetGroup",
      "Properties" : {
        "Protocol" : "HTTP",
        "Port" : 80,
        "VpcId" : "vpc-0c6e6c6c8632fb271",
        "HealthCheckEnabled" : true,
        "HealthCheckIntervalSeconds" : 120,
        "HealthCheckPath" : "/",
        "HealthCheckPort" : "traffic-port",
        "HealthCheckProtocol" : "HTTP",
        "HealthCheckTimeoutSeconds" : 60,
        "HealthyThresholdCount" : 2,
        "IpAddressType" : "ipv4",
        "Matcher" : {
          "HttpCode": "200"
        },
        "ProtocolVersion" : "HTTP1",
        "TargetType" : "ip",
        "UnhealthyThresholdCount" : 2,
      }
    },
    "ECSWebTargetGroup": {
      "Type" : "AWS::ElasticLoadBalancingV2::TargetGroup",
      "Properties" : {
        "Protocol" : "HTTP",
        "Port" : 80,
        "VpcId" : "vpc-0c6e6c6c8632fb271",
        "HealthCheckEnabled" : true,
        "HealthCheckIntervalSeconds" : 120,
        "HealthCheckPath" : "/",
        "HealthCheckPort" : "traffic-port",
        "HealthCheckProtocol" : "HTTP",
        "HealthCheckTimeoutSeconds" : 60,
        "HealthyThresholdCount" : 2,
        "IpAddressType" : "ipv4",
        "Matcher" : {
          "HttpCode": "200"
        },
        "ProtocolVersion" : "HTTP1",
        "TargetType" : "ip",
        "UnhealthyThresholdCount" : 2,
      }
    },
    ------------------FIXME
    "ECSApiLoadBalancer": {
      "Type": "AWS::ElasticLoadBalancingV2::LoadBalancer",
      "Properties": {
        "IpAddressType" : "ipv4",
        "LoadBalancerAttributes" : [ FIXME_LoadBalancerAttribute, ... ],
        "Name" : "ecos-api-alb",
        "Scheme" : "internal",
        "SecurityGroups" : [ "sg-05ce9300d9ef7e407" ],
        "Subnets" : [ "subnet-0160efb3bae4e4d37", "subnet-0941b88ce2f2f04c0" ],
        "Tags" : [ Tag, ... ],
        "Type" : String
    },
    "ECSWebLoadBalancer": {
      "Type": "AWS::ElasticLoadBalancingV2::LoadBalancer",
      "Properties": {
        "IpAddressType" : "ipv4",
        "LoadBalancerAttributes" : [ FIXME_LoadBalancerAttribute, ... ],
        "Name" : "ecos-ui-alb",
        "Scheme" : "internal",
        "SecurityGroups" : [ "sg-0cb07781b65f0b9fc" ],
        "Subnets" : [ "subnet-0160efb3bae4e4d37", "subnet-0941b88ce2f2f04c0" ],
        "Tags" : [ Tag, ... ],
        "Type" : String
    }
  },
    
    -------------------FIXME ADD VPC
},
  "Outputs": {
    "ECSCluster": {
      "Description": "The created cluster.",
      "Value": {
        "Ref": "ApiECSCluster"
      }
    },
    "ECSCluster": {
      "Description": "The created cluster.",
      "Value": {
        "Ref": "WebECSCluster"
      }
    },
  "ECSService": {
      "Description": "The created service.",
      "Value": {
        "Ref": "ApiECSService"
      }
    },
    "ECSService": {
      "Description": "The created service.",
      "Value": {
        "Ref": "WebECSService"
      }
    }
  }
}
