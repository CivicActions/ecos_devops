{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "Template to create core ECOS resources.",
  "Parameters": {
    "DevApiECSClusterName": {
      "Type": "String",
      "Description": "Specifies the ECS Cluster Name with which the resources would be associated",
      "Default": "dev-ecos-api-ecs-cluster"
    },
    "DevWebECSClusterName": {
      "Type": "String",
      "Description": "Specifies the ECS Cluster Name with which the resources would be associated",
      "Default": "dev-ecos-web-ecs-cluster"
    },
    "DevSecurityGroupIDs": {
      "Type": "CommaDelimitedList",
      "Default": {
	    "Ref": "DevDefaultSecurityGroup"
      }
    },
    "DevSubnetIDs": {
      "Type": "CommaDelimitedList",
      "Default": "subnet-0941b88ce2f2f04c0,subnet-006cfb1b38a9040d2,subnet-0dea032c80563fb24,subnet-054df7c9fbcdbae9e,subnet-0160efb3bae4e4d37,subnet-08b52b072d0f1b4c3"
    },
    "DevWebVpcID": {
      "Type": "String",
      "Default": {
        "Ref": "DevECSVPC"
      }
    },
  },
  "Resources": {
    "DevECSVPC": {
      "Type" : "AWS::EC2::VPC",
      "Properties" : {
        "CidrBlock" : "172.31.0.0/16",
        "InstanceTenancy" : "default"
      }
    },
    "DevApiECSCluster": {
      "Type": "AWS::ECS::Cluster",
      "Properties": {
        "ClusterName": {
          "Ref": "DevApiECSClusterName"
        },  
        "CapacityProviders": [
          "FARGATE",
          "FARGATE_SPOT"
        ],
        "ClusterSettings": [
          {
            "Name": "containerInsights",
            "Value": "disabled"
          }
        ],
        "Configuration": {
          "ExecuteCommandConfiguration": {
            "Logging": "DEFAULT"
          }
        },
        "ServiceConnectDefaults": {
          "Namespace": "dev-ecos-api-ecs-cluster"
        },
        "Tags": [
          {
            "Key": "Name",
            "Value": "dev-ecos-api-ecs-cluster"
          }
        ]
      }
    },
    "DevWebECSCluster": {
      "Type": "AWS::ECS::Cluster",
      "Properties": {
        "ClusterName": {
          "Ref": "DevWebECSClusterName"
        },
        "CapacityProviders": [
          "FARGATE",
          "FARGATE_SPOT"
        ],
        "ClusterSettings": [
          {
            "Name": "containerInsights",
            "Value": "disabled"
          }
        ],
        "Configuration": {                                                          "ExecuteCommandConfiguration": {
            "Logging": "DEFAULT"
          }
        },
        "ServiceConnectDefaults": {
          "Namespace": "dev-ecos-web-ecs-cluster"
        },
        "Tags": [
          {
            "Key": "Name",
            "Value": "dev-ecos-web-ecs-cluster"
          }
        ]
      }
    },
    "DevApiTaskDefinition": {
      "Type" : "AWS::ECS::TaskDefinition",
      "Properties" : {
        "containerDefinitions": [
        {
          "name": "dev-ecos-api-cont",
          "image": "058264367679.dkr.ecr.us-east-1.amazonaws.com/ecos-api-repo:latest",
          "cpu": 0,
          "portMappings": [
            {
              "name": "dev-ecos-api-cont-8001-tcp",
              "containerPort": 8001,
              "hostPort": 8001,
              "protocol": "tcp"
            }
          ],
          "essential": true,
          "environment": [
            {
              "name": "VERSION",
              "value": "v1"
            },
            {
              "name": "ENVIRONMENT",
              "value": "dev"
            }
          ],
          "mountPoints": [],
          "volumesFrom": [],
          "workingDirectory": "/app",
          "logConfiguration": {
            "logDriver": "awslogs",
            "options": {
              "awslogs-group": "/ecs/ecos-api",
              "awslogs-region": "us-east-1",
              "awslogs-stream-prefix": "ecos-api"
            }
          }
        }
        ],
        "Cpu" : 4096,
        "ExecutionRoleArn" : "arn:aws:iam::058264367679:role/dev-ecos-ecs-task-execution-role",
        "Family" : "dev-ecos-api-td",
        "Memory" : 8192,
        "NetworkMode" : "awsvpc",
        "RequiresCompatibilities" : [ "FARGATE" ],
        "TaskRoleArn" : "arn:aws:iam::058264367679:role/dev-ecos-ecs-task-role"
      }
    },
    "DevWebTaskDefinition": {
      "Type" : "AWS::ECS::TaskDefinition",
      "Properties" : {
        "ContainerDefinitions" : [
        {
          "name": "ecos-ui-cont",
          "image": "058264367679.dkr.ecr.us-east-1.amazonaws.com/ecos-web-repo:latest",
          "cpu": 0,
          "portMappings": [
          {
            "name": "dev-ecos-ui-cont-8002-tcp",
            "containerPort": 8002,
            "hostPort": 8002,
            "protocol": "tcp"
          }
          ],
          "essential": true,
          "environment": [
          {
            "name": "VERSION",
            "value": "v1"
          },
          {
            "name": "ENVIRONMENT",
            "value": "dev"
          }
          ],
          "mountPoints": [],
          "volumesFrom": [],
          "workingDirectory": "/app",
          "logConfiguration": {
          "logDriver": "awslogs",
          "options": {
            "awslogs-group": "/ecs/ecos-ui",
            "awslogs-region": "us-east-1",
            "awslogs-stream-prefix": "ecos-ui"
          }
          }
        }
        ],
        "Cpu" : 4096,
        "ExecutionRoleArn" : "arn:aws:iam::058264367679:role/ecos-ecs-task-execution-role",
        "Family" : "ecos-ui-td",
        "Memory" : 8192,
        "NetworkMode" : "awsvpc",
        "RequiresCompatibilities" : [ "FARGATE" ],
        "TaskRoleArn" : "arn:aws:iam::058264367679:role/ecos-ecs-task-role"
      }
    },
    "DevApiSecurityGroup": {
      "Type" : "AWS::EC2::SecurityGroup",
      "Properties" : {
        "GroupDescription" : "dev-ecos-api-alb-sg",
        "GroupName" : "dev-ecos-api-alb-sg",
        "SecurityGroupEgress" : [
          {
            "CidrIp" : "0.0.0.0/0",
            "IpProtocol" : "-1",
          },
        ],
        "SecurityGroupIngress" : [
          {
            "CidrIp" : "0.0.0.0/0",
            "IpProtocol" : "-1",
          },
        ],
        "Tags": [
          {
            "Key": "Name",
            "Value": "dev-ecos-api-alb-sg"
          },
          {
            "Key": "Environment",
            "Value": "dev"
          }
        ],
        "VpcId" :  {
          "Ref": "DevECSVPC"
        }
      }
    },
    "DevWebSecurityGroup": {
      "Type" : "AWS::EC2::SecurityGroup",
      "Properties" : {
        "GroupDescription" : "dev-ecos-web-alb-sg",
        "GroupName" : "dev-ecos-web-alb-sg",
        "SecurityGroupEgress" : [
          {
            "CidrIp" : "0.0.0.0/0",
            "IpProtocol" : "-1",
          },
        ],
        "SecurityGroupIngress" : [
          {
            "CidrIp" : "0.0.0.0/0",
            "FromPort" : 0,
            "IpProtocol" : "tcp",
            "ToPort" : 0,
          },
        ],
        "Tags": [
          {
            "Key": "Name",
            "Value": "dev-ecos-web-alb-sg"
          },
          {
            "Key": "Environment",
            "Value": "dev"
          }
        ],
        "VpcId" :  {
          "Ref": "DevECSVPC"
        }
      }
    },
    "DevDefaultSecurityGroup": {
      "Type" : "AWS::EC2::SecurityGroup",
      "Properties" : {
        "GroupDescription" : "default VPC security group",
        "GroupName" : "default",
        "SecurityGroupEgress"															 : [
          {
            "CidrIp" : "0.0.0.0/0",
            "IpProtocol" : "-1"
          },
        ],
        "SecurityGroupIngress" : [
          {
            "IpProtocol" : "-1",
			"GroupId": "sg-0de3c1e1a134c66d8",
			"GroupName": String
          },
        ],
        "VpcId" :  {
          "Ref": "DevECSVPC"
        }
      }
    },
    "DevApiECSService": {
      "Type": "AWS::ECS::Service",
      "Properties": {
        "Cluster": "dev-ecos-api-ecs-cluster",
        "CapacityProviderStrategy": [
          {
            "CapacityProvider": "FARGATE",
            "Base": 0,
            "Weight": 1
          }
        ],
        "TaskDefinition": "arn:aws:ecs:us-east-1:058264367679:task-definition/dev-ecos-api-td:1",
        "ServiceName": "dev-ecos-api-service",
        "SchedulingStrategy": "REPLICA",
        "DesiredCount": 1,
        "NetworkConfiguration": {
          "AwsvpcConfiguration": {
            "AssignPublicIp": "ENABLED",
            "SecurityGroups": {
              "Ref": "SecurityGroupIDs"
            },
            "Subnets": {
              "Ref": "DevSubnetIDs"
            }
          }
        },
        "PlatformVersion": "LATEST",
        "DeploymentConfiguration": {
          "MaximumPercent": 200,
          "MinimumHealthyPercent": 100,
          "DeploymentCircuitBreaker": {
            "Enable": true,
            "Rollback": true
          }
        },
        "DeploymentController": {
          "Type": "ECS"
        },
        "ServiceConnectConfiguration": {
          "Enabled": false
        },
        "Tags": [
          {
            "Key": "Name",
            "Value": "dev-ecos-api-service"
          },
          {
            "Key": "Environment",
            "Value": "dev"
          }
        ],
        "EnableECSManagedTags": true
      }
    },
    "DevWebECSService": {
      "Type": "AWS::ECS::Service",
      "Properties": {
        "Cluster": "dev-ecos-web-ecs-cluster",
        "CapacityProviderStrategy": [
          {
            "CapacityProvider": "FARGATE",
            "Base": 0,
            "Weight": 1
          }
        ],
        "TaskDefinition": "arn:aws:ecs:us-east-1:058264367679:task-definition/dev-ecos-ui-td:1",
        "ServiceName": "dev-ecos-ui-service",
        "SchedulingStrategy": "REPLICA",
        "DesiredCount": 1,
        "NetworkConfiguration": {
          "AwsvpcConfiguration": {
            "AssignPublicIp": "ENABLED",
            "SecurityGroups": {
              "Ref": "SecurityGroupIDs"
            },
            "Subnets": {
              "Ref": "DevSubnetIDs"
            }
          }
        },
        "PlatformVersion": "LATEST",
        "DeploymentConfiguration": {
          "MaximumPercent": 200,
          "MinimumHealthyPercent": 100,
          "DeploymentCircuitBreaker": {
            "Enable": true,
            "Rollback": true
          }
        },
        "DeploymentController": {
          "Type": "ECS"
        },
        "ServiceConnectConfiguration": {
          "Enabled": false
        },
        "Tags": [
          {
            "Key": "Name",
            "Value": "dev-ecos-ui-service"
          },
          {
            "Key": "Environment",
            "Value": "dev"
          }
        ],
        "EnableECSManagedTags": true
      }
    },
    "DevECSApiTargetGroup": {
      "Type" : "AWS::ElasticLoadBalancingV2::TargetGroup",
      "Properties" : {
        "Protocol" : "HTTP",
        "Port" : 80,
        "VpcId" :  {
          "Ref": "DevECSVPC"
         },
        "HealthCheckEnabled" : true,
        "HealthCheckIntervalSeconds" : 120,
        "HealthCheckPath" : "/",
        "HealthCheckPort" : "traffic-port",
        "HealthCheckProtocol" : "HTTP",
        "HealthCheckTimeoutSeconds" : 60,
        "HealthyThresholdCount" : 2,
        "IpAddressType" : "ipv4",
        "Matcher" : {
          "HttpCode": "200"
        },
        "ProtocolVersion" : "HTTP1",
        "TargetType" : "ip",
        "UnhealthyThresholdCount" : 2,
      }
    },
    "ECSWebTargetGroup": {
      "Type" : "AWS::ElasticLoadBalancingV2::TargetGroup",
      "Properties" : {
        "Protocol" : "HTTP",
        "Port" : 80,
        "VpcId" :  {
          "Ref": "DevECSVPC"
        },
        "HealthCheckEnabled" : true,
        "HealthCheckIntervalSeconds" : 120,
        "HealthCheckPath" : "/",
        "HealthCheckPort" : "traffic-port",
        "HealthCheckProtocol" : "HTTP",
        "HealthCheckTimeoutSeconds" : 60,
        "HealthyThresholdCount" : 2,
        "IpAddressType" : "ipv4",
        "Matcher" : {
          "HttpCode": "200"
        },
        "ProtocolVersion" : "HTTP1",
        "TargetType" : "ip",
        "UnhealthyThresholdCount" : 2,
      }
    },
    "DevECSApiLoadBalancer": {
      "Type": "AWS::ElasticLoadBalancingV2::LoadBalancer",
      "Properties": {
        "IpAddressType" : "ipv4",
        "Name" : "dev-ecos-api-alb",
        "Scheme" : "internal",
        "SecurityGroups" : [
          {
            "Ref": "DevApiSecurityGroup"
          }
        ],
        "Subnets" : [ "subnet-0160efb3bae4e4d37", "subnet-0941b88ce2f2f04c0" ],
        "Type" : "application"
    },
    "DevECSWebLoadBalancer": {
      "Type": "AWS::ElasticLoadBalancingV2::LoadBalancer",
      "Properties": {
        "IpAddressType" : "ipv4",
        "Name" : "dev-ecos-ui-alb",
        "Scheme" : "internal",
        "SecurityGroups" : [
          {
            "Ref": "DevWebSecurityGroup"
          }
        ],
        "Subnets" : [ "subnet-0160efb3bae4e4d37", "subnet-0941b88ce2f2f04c0" ],
        "Type" : "application"
      }
    },
  },
  "Outputs": {
    "ECSCluster": {
      "Description": "The created cluster.",
      "Value": {
        "Ref": "DevApiECSCluster"
      }
    },
    "ECSCluster": {
      "Description": "The created cluster.",
      "Value": {
        "Ref": "DevWebECSCluster"
      }
    },
    "ECSService": {
      "Description": "The created service.",
      "Value": {
        "Ref": "DevApiECSService"
      }
    },
    "ECSService": {
      "Description": "The created service.",
      "Value": {
        "Ref": "DevWebECSService"
      }
    }
  }
}
