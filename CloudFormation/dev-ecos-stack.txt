{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "Template to create core ECOS resources.",
  "Parameters": {
    "DevApiECSClusterName": {
      "Type": "String",
      "Description": "Specifies the ECS Cluster Name with which the resources would be associated",
      "Default": "dev-ecos-api-ecs-cluster"
    },
    "DevWebECSClusterName": {
      "Type": "String",
      "Description": "Specifies the ECS Cluster Name with which the resources would be associated",
      "Default": "dev-ecos-web-ecs-cluster"
    }
  },
  "Resources": {
    "DevECSVPC": {
      "Type" : "AWS::EC2::VPC",
      "Properties" : {
        "CidrBlock" : "172.31.0.0/16",
        "InstanceTenancy" : "default"
      }
    },
    "DevSubnetA": {
      "Type" : "AWS::EC2::Subnet",
      "Properties" : {
        "AvailabilityZone" : "us-east-1a",
        "CidrBlock" : "172.31.80.0/20",
        "EnableDns64" : false,
        "Ipv6Native" : false,
        "MapPublicIpOnLaunch" : true,
        "PrivateDnsNameOptionsOnLaunch" : {
          "HostnameType": "ip-name",
          "EnableResourceNameDnsARecord": false,
          "EnableResourceNameDnsAAAARecord": false
        },
        "VpcId" : {
          "Ref": "DevECSVPC"
        }
      }
	},
    "DevSubnetB": {
      "Type" : "AWS::EC2::Subnet",
      "Properties" : {
        "AvailabilityZone" : "us-east-1b",
        "CidrBlock" : "172.31.16.0/20",
        "EnableDns64" : false,
        "Ipv6Native" : false,
        "MapPublicIpOnLaunch" : true,
        "PrivateDnsNameOptionsOnLaunch" : {
          "HostnameType": "ip-name",
          "EnableResourceNameDnsARecord": false,
          "EnableResourceNameDnsAAAARecord": false
        },
        "VpcId" : {
          "Ref": "DevECSVPC"
        }
      }
	},
    "DevSubnetC": {
      "Type" : "AWS::EC2::Subnet",
      "Properties" : {
        "AvailabilityZone" : "us-east-1c",
        "CidrBlock" : "172.31.32.0/20",
        "EnableDns64" : false,
        "Ipv6Native" : false,
        "MapPublicIpOnLaunch" : true,
        "PrivateDnsNameOptionsOnLaunch" : {
          "HostnameType": "ip-name",
          "EnableResourceNameDnsARecord": false,
          "EnableResourceNameDnsAAAARecord": false
        },
        "VpcId" : {
          "Ref": "DevECSVPC"
        }
      }
	},
    "DevSubnetD": {
      "Type" : "AWS::EC2::Subnet",
      "Properties" : {
        "AvailabilityZone" : "us-east-1d",
        "CidrBlock" : "172.31.0.0/20",
        "EnableDns64" : false,
        "Ipv6Native" : false,
        "MapPublicIpOnLaunch" : true,
        "PrivateDnsNameOptionsOnLaunch" : {
          "HostnameType": "ip-name",
          "EnableResourceNameDnsARecord": false,
          "EnableResourceNameDnsAAAARecord": false
        },
        "VpcId" : {
          "Ref": "DevECSVPC"
        }
      }
	},
    "DevSubnetE": {
      "Type" : "AWS::EC2::Subnet",
      "Properties" : {
        "AvailabilityZone" : "us-east-1e",
        "CidrBlock" : "172.31.48.0/20",
        "EnableDns64" : false,
        "Ipv6Native" : false,
        "MapPublicIpOnLaunch" : true,
        "PrivateDnsNameOptionsOnLaunch" : {
          "HostnameType": "ip-name",
          "EnableResourceNameDnsARecord": false,
          "EnableResourceNameDnsAAAARecord": false
        },
        "VpcId" : {
          "Ref": "DevECSVPC"
        }
      }
	},
	"DevSubnetF": {
      "Type" : "AWS::EC2::Subnet",
      "Properties" : {
        "AvailabilityZone" : "us-east-1f",
        "CidrBlock" : "172.31.64.0/20",
        "EnableDns64" : false,
        "Ipv6Native" : false,
        "MapPublicIpOnLaunch" : true,
        "PrivateDnsNameOptionsOnLaunch" : {
          "HostnameType": "ip-name",
          "EnableResourceNameDnsARecord": false,
          "EnableResourceNameDnsAAAARecord": false
        },
        "VpcId" : {
          "Ref": "DevECSVPC"
        }
      }
	},
    "DevApiECSCluster": {
      "Type": "AWS::ECS::Cluster",
      "Properties": {
        "ClusterName": {
          "Ref": "DevApiECSClusterName"
        },  
        "CapacityProviders": [
          "FARGATE",
          "FARGATE_SPOT"
        ],
        "ClusterSettings": [
          {
            "Name": "containerInsights",
            "Value": "disabled"
          }
        ],
        "Configuration": {
          "ExecuteCommandConfiguration": {
            "Logging": "DEFAULT"
          }
        },
        "ServiceConnectDefaults": {
          "Namespace": { "Ref": "DevApiECSClusterName" }
        },
        "Tags": [
          {
            "Key": "Name",
            "Value": { "Ref": "DevApiECSClusterName" }
          }
        ]
      }
    },
    "DevWebECSCluster": {
      "Type": "AWS::ECS::Cluster",
      "Properties": {
        "ClusterName": {
          "Ref": "DevWebECSClusterName"
        },
        "CapacityProviders": [
          "FARGATE",
          "FARGATE_SPOT"
        ],
        "ClusterSettings": [
          {
            "Name": "containerInsights",
            "Value": "disabled"
          }
        ],
        "Configuration": {                                                          "ExecuteCommandConfiguration": {
            "Logging": "DEFAULT"
          }
        },
        "ServiceConnectDefaults": {
          "Namespace": { "Ref": "DevWebECSClusterName" }
        },
        "Tags": [
          {
            "Key": "Name",
            "Value": { "Ref": "DevWebECSClusterName" }
          }
        ]
      }
    },
    "DevApiTaskDefinition": {
      "Type" : "AWS::ECS::TaskDefinition",
      "Properties" : {
        "ContainerDefinitions": [
        {
          "Name": "dev-ecos-api-cont",
          "Image": "058264367679.dkr.ecr.us-east-1.amazonaws.com/ecos-api-repo:latest",
          "Cpu": 0,
          "PortMappings": [
            {
              "Name": "dev-ecos-api-cont-8001-tcp",
              "ContainerPort": 8001,
              "HostPort": 8001,
              "Protocol": "tcp"
            }
          ],
          "Essential": true,
          "Environment": [
            {
              "Name": "VERSION",
              "Value": "v1"
            },
            {
              "Name": "ENVIRONMENT",
              "Value": "dev"
            }
          ],
          "MountPoints": [],
          "VolumesFrom": [],
          "WorkingDirectory": "/app",
          "LogConfiguration": {
            "LogDriver": "awslogs",
            "Options": {
              "awslogs-group": "/ecs/ecos-api",
              "awslogs-region": "us-east-1",
              "awslogs-stream-prefix": "ecos-api"
            }
          }
        }
        ],
        "Cpu" : 4096,
        "ExecutionRoleArn" : "arn:aws:iam::058264367679:role/dev-ecos-ecs-task-execution-role",
        "Family" : "dev-ecos-api-td",
        "Memory" : 8192,
        "NetworkMode" : "awsvpc",
        "RequiresCompatibilities" : [ "FARGATE" ],
        "TaskRoleArn" : "arn:aws:iam::058264367679:role/dev-ecos-ecs-task-role"
      }
    },
    "DevWebTaskDefinition": {
      "Type" : "AWS::ECS::TaskDefinition",
      "Properties" : {
        "ContainerDefinitions" : [
        {
          "Name": "dev-ecos-web-cont",
          "Image": "058264367679.dkr.ecr.us-east-1.amazonaws.com/ecos-web-repo:latest",
          "Cpu": 0,
          "PortMappings": [
          {
            "Name": "dev-ecos-web-cont-4321-tcp",
            "ContainerPort": 4321,
            "HostPort": 4321,
            "Protocol": "tcp"
          }
          ],
          "Essential": true,
          "Environment": [
            {
              "Name": "VERSION",
              "Value": "v1"
            },
            {
              "Name": "MARKETPLACE_API_KEY ",
              "Value": "FIXME:We need somewhere more secure than Git to store this"
            },
            {
              "Name": "MARKETPLACE_BASE_URL",
              "Value": "https://marketplace.api.healthcare.gov/api/v1"
            },
            {
              "Name": "ENVIRONMENT",
              "Value": "dev"
            }
          ],
          "MountPoints": [],
          "VolumesFrom": [],
          "WorkingDirectory": "/app",
          "LogConfiguration": {
            "LogDriver": "awslogs",
            "Options": {
              "awslogs-group": "/ecs/ecos-web",
              "awslogs-region": "us-east-1",
              "awslogs-stream-prefix": "ecos-web"
            }
          }
        }
        ],
        "Cpu" : 4096,
        "ExecutionRoleArn" : "arn:aws:iam::058264367679:role/dev-ecos-ecs-task-execution-role",
        "Family" : "dev-ecos-web-td",
        "Memory" : 8192,
        "NetworkMode" : "awsvpc",
        "RequiresCompatibilities" : [ "FARGATE" ],
        "TaskRoleArn" : "arn:aws:iam::058264367679:role/dev-ecos-ecs-task-role"
      }
    },
    "DevApiSecurityGroup": {
      "Type" : "AWS::EC2::SecurityGroup",
      "Properties" : {
        "GroupDescription" : "dev-ecos-api-alb-sg",
        "GroupName" : "dev-ecos-api-alb-sg",
        "SecurityGroupEgress" : [
          {
            "CidrIp" : "0.0.0.0/0",
            "IpProtocol" : "-1"
          }
        ],
        "SecurityGroupIngress" : [
          {
            "CidrIp" : "0.0.0.0/0",
            "IpProtocol" : "-1"
          }
        ],
        "Tags": [
          {
            "Key": "Name",
            "Value": "dev-ecos-api-alb-sg"
          },
          {
            "Key": "Environment",
            "Value": "dev"
          }
        ],
        "VpcId" :  {
          "Ref": "DevECSVPC"
        }
      }
    },
    "DevWebSecurityGroup": {
      "Type" : "AWS::EC2::SecurityGroup",
      "Properties" : {
        "GroupDescription" : "dev-ecos-web-alb-sg",
        "GroupName" : "dev-ecos-web-alb-sg",
        "SecurityGroupEgress" : [
          {
            "CidrIp" : "0.0.0.0/0",
            "IpProtocol" : "-1"
          }
        ],
        "SecurityGroupIngress" : [
          {
            "CidrIp" : "0.0.0.0/0",
            "FromPort" : 0,
            "IpProtocol" : "tcp",
            "ToPort" : 0
          }
        ],
        "Tags": [
          {
            "Key": "Name",
            "Value": "dev-ecos-web-alb-sg"
          },
          {
            "Key": "Environment",
            "Value": "dev"
          }
        ],
        "VpcId" :  {
          "Ref": "DevECSVPC"
        }
      }
    },
    "DevDefaultSecurityGroup": {
      "Type" : "AWS::EC2::SecurityGroup",
      "Properties" : {
        "GroupDescription" : "default VPC security group",
        "GroupName" : "dev-default",
        "SecurityGroupEgress": [
          {
            "CidrIp" : "0.0.0.0/0",
            "IpProtocol" : "-1"
          }
        ],
        "SecurityGroupIngress" : [
          {
            "IpProtocol" : "-1"
          }
        ],
        "VpcId" :  {
          "Ref": "DevECSVPC"
        }
      }
    },
    "DevECSApiTargetGroup": {
      "Type" : "AWS::ElasticLoadBalancingV2::TargetGroup",
      "Properties" : {
        "Protocol" : "HTTP",
        "Port" : 80,
        "VpcId" :  {
          "Ref": "DevECSVPC"
         },
        "HealthCheckEnabled" : true,
        "HealthCheckIntervalSeconds" : 120,
        "HealthCheckPath" : "/",
        "HealthCheckPort" : "traffic-port",
        "HealthCheckProtocol" : "HTTP",
        "HealthCheckTimeoutSeconds" : 60,
        "HealthyThresholdCount" : 2,
        "IpAddressType" : "ipv4",
        "Matcher" : {
          "HttpCode": "200"
        },
        "ProtocolVersion" : "HTTP1",
        "TargetType" : "ip",
        "UnhealthyThresholdCount" : 2
      }
    },
    "DevECSWebTargetGroup": {
      "Type" : "AWS::ElasticLoadBalancingV2::TargetGroup",
      "Properties" : {
        "Protocol" : "HTTP",
        "Port" : 80,
        "VpcId" :  {
          "Ref": "DevECSVPC"
        },
        "HealthCheckEnabled" : true,
        "HealthCheckIntervalSeconds" : 120,
        "HealthCheckPath" : "/",
        "HealthCheckPort" : "traffic-port",
        "HealthCheckProtocol" : "HTTP",
        "HealthCheckTimeoutSeconds" : 60,
        "HealthyThresholdCount" : 2,
        "IpAddressType" : "ipv4",
        "Matcher" : {
          "HttpCode": "200"
        },
        "ProtocolVersion" : "HTTP1",
        "TargetType" : "ip",
        "UnhealthyThresholdCount" : 2
      }
    },
    "DevECSApiLoadBalancer": {
      "Type": "AWS::ElasticLoadBalancingV2::LoadBalancer",
      "Properties": {
        "IpAddressType" : "ipv4",
        "Name" : "dev-ecos-api-alb",
        "Scheme" : "internal",
        "SecurityGroups" : [
          {
            "Ref": "DevApiSecurityGroup"
          }
        ],
        "Subnets" :  [
          { "Ref": "DevSubnetA" },
          { "Ref": "DevSubnetD" }
        ],
        "Type" : "application"
      }
    },
    "DevECSWebLoadBalancer": {
      "Type": "AWS::ElasticLoadBalancingV2::LoadBalancer",
      "Properties": {
        "IpAddressType" : "ipv4",
        "Name" : "dev-ecos-web-alb",
        "Scheme" : "internal",
        "SecurityGroups" : [
          {
            "Ref": "DevWebSecurityGroup"
          }
        ],
        "Subnets" :  [
          { "Ref": "DevSubnetA" },
          { "Ref": "DevSubnetD" }
        ],
        "Type" : "application"
      }
    },
	"DevECSApiListener": {
      "Type" : "AWS::ElasticLoadBalancingV2::Listener",
      "Properties" : {
        "DefaultActions": [
          {
            "Type": "forward",
            "TargetGroupArn": { "Ref": "DevECSApiTargetGroup" },
            "ForwardConfig": {
              "TargetGroups": [
                {
                  "TargetGroupArn": { "Ref": "DevECSApiTargetGroup" },
                  "Weight": 1
                }
              ],
              "TargetGroupStickinessConfig": {
                "Enabled": false
              }
            }
          }
        ],
        "LoadBalancerArn" : { "Ref": "DevECSApiLoadBalancer" },
        "MutualAuthentication" : MutualAuthentication,
        "Port" : 80,
        "Protocol" : HTTP
      }
    },
	"DevECSWebListener": {
      "Type" : "AWS::ElasticLoadBalancingV2::Listener",
      "Properties" : {
        "DefaultActions": [
          {
            "Type": "forward",
            "TargetGroupArn": { "Ref": "DevECSWebTargetGroup" },
            "ForwardConfig": {
              "TargetGroups": [
                {
                  "TargetGroupArn": { "Ref": "DevECSWebTargetGroup" },
                  "Weight": 1
                }
              ],
              "TargetGroupStickinessConfig": {
                "Enabled": false
              }
            }
          }
        ],
        "LoadBalancerArn" : { "Ref": "DevECSWebLoadBalancer" },
        "MutualAuthentication" : MutualAuthentication,
        "Port" : 80,
        "Protocol" : HTTP
      }
    },
	"DevApiECSService": {
      "Type": "AWS::ECS::Service",
	  "DependsOn": "DevECSApiListener",
      "Properties": {
        "Cluster": { "Ref": "DevApiECSClusterName" },
        "LoadBalancers": [
          {
            "TargetGroupArn": { "Ref": "DevECSApiTargetGroup" },
            "ContainerName": "dev-ecos-api-cont",
            "ContainerPort": 4321
          }
        ],
        "CapacityProviderStrategy": [
          {
            "CapacityProvider": "FARGATE",
            "Base": 0,
            "Weight": 1
          }
        ],
        "TaskDefinition": { "Ref": "DevApiTaskDefinition" },
        "ServiceName": "dev-ecos-api-service",
        "SchedulingStrategy": "REPLICA",
        "DesiredCount": 1,
        "NetworkConfiguration": {
          "AwsvpcConfiguration": {
            "AssignPublicIp": "ENABLED",
            "SecurityGroups": [
              { "Ref": "DevDefaultSecurityGroup" }
            ],
            "Subnets": [
			  { "Ref": "DevSubnetA" },
              { "Ref": "DevSubnetB" },
              { "Ref": "DevSubnetC" },
              { "Ref": "DevSubnetD" },
              { "Ref": "DevSubnetE" },
              { "Ref": "DevSubnetF" }
            ]
          }
        },
        "PlatformVersion": "LATEST",
        "DeploymentConfiguration": {
          "MaximumPercent": 200,
          "MinimumHealthyPercent": 100,
          "DeploymentCircuitBreaker": {
            "Enable": true,
            "Rollback": true
          }
        },
        "DeploymentController": {
          "Type": "ECS"
        },
        "ServiceConnectConfiguration": {
          "Enabled": false
        },
        "Tags": [
          {
            "Key": "Name",
            "Value": "dev-ecos-api-service"
          },
          {
            "Key": "Environment",
            "Value": "dev"
          }
        ],
        "EnableECSManagedTags": true
      }
    },
    "DevWebECSService": {
      "Type": "AWS::ECS::Service",
	  "DependsOn": "DevECSWebListener",
      "Properties": {
        "Cluster": { "Ref": "DevWebECSClusterName" },
        "LoadBalancers": [
          {
            "TargetGroupArn": { "Ref": "DevECSWebTargetGroup" },
            "ContainerName": "dev-ecos-web-cont",
            "ContainerPort": 4321
          }
        ],
        "CapacityProviderStrategy": [
          {
            "CapacityProvider": "FARGATE",
            "Base": 0,
            "Weight": 1
          }
        ],
        "TaskDefinition": { "Ref": "DevWebTaskDefinition" },
        "ServiceName": "dev-ecos-web-service",
        "SchedulingStrategy": "REPLICA",
        "DesiredCount": 1,
        "NetworkConfiguration": {
          "AwsvpcConfiguration": {
            "AssignPublicIp": "ENABLED",
            "SecurityGroups": [ 
              { "Ref": "DevDefaultSecurityGroup" }
            ],
            "Subnets": [
			  { "Ref": "DevSubnetA" },
              { "Ref": "DevSubnetB" },
              { "Ref": "DevSubnetC" },
              { "Ref": "DevSubnetD" },
              { "Ref": "DevSubnetE" },
              { "Ref": "DevSubnetF" }
            ]
          }
        },
        "PlatformVersion": "LATEST",
        "DeploymentConfiguration": {
          "MaximumPercent": 200,
          "MinimumHealthyPercent": 100,
          "DeploymentCircuitBreaker": {
            "Enable": true,
            "Rollback": true
          }
        },
        "DeploymentController": {
          "Type": "ECS"
        },
        "ServiceConnectConfiguration": {
          "Enabled": false
        },
        "Tags": [
          {
            "Key": "Name",
            "Value": "dev-ecos-web-service"
          },
          {
            "Key": "Environment",
            "Value": "dev"
          }
        ],
        "EnableECSManagedTags": true
      }
    }
  },
  "Outputs": {
    "ECSCluster": {
      "Description": "The created cluster.",
      "Value": {
        "Ref": "DevApiECSCluster"
      }
    },
    "ECSCluster": {
      "Description": "The created cluster.",
      "Value": {
        "Ref": "DevWebECSCluster"
      }
    },
    "ECSService": {
      "Description": "The created service.",
      "Value": {
        "Ref": "DevApiECSService"
      }
    },
    "ECSService": {
      "Description": "The created service.",
      "Value": {
        "Ref": "DevWebECSService"
      }
    }
  }
}